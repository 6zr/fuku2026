<!DOCTYPE html>
<html lang="ja">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-VW1EHGZ7WM"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-VW1EHGZ7WM');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>シロクマのお餅焼き</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #fce7d2;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
        }
        .game-outer {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
        .game-container {
            width: 100%;
            max-width: 600px;
            min-height: 90vh; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 10px;
            position: relative;
        }

        .game-header {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding-top: 10px;
            z-index: 100;
        }

        .header-top-row {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 5px;
        }

        .score-row {
            display: flex;
            gap: 6px;
        }

        .stage {
            position: relative;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-top: 5px;
            gap: 10px;
        }
        
        .fukuwarai-viewer {
            position: relative;
            width: 240px; 
            height: 250px;
            background: transparent;
            border: none;
            overflow: visible;
            z-index: 1;
        }

        .bear-face-system {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .bear-shadow {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 160px;
            height: 20px;
            background: rgba(0,0,0,0.05);
            border-radius: 50%;
            z-index: 0;
        }

        @keyframes wakuwaku {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(1px, -1px) rotate(0.5deg); }
            75% { transform: translate(-1px, -0.5px) rotate(-0.5deg); }
        }
        .anim-wakuwaku { animation: wakuwaku 0.2s infinite; }

        @keyframes hopping {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-12px); }
        }
        .anim-hopping { animation: hopping 0.4s infinite cubic-bezier(0.45, 0.05, 0.55, 0.95); }

        .face-base {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            pointer-events: none;
            user-select: none;
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.05));
        }
        
        #fuku-parts-container {
            position: absolute;
            top: 0; left: 0; 
            width: 100%; height: 100%;
            pointer-events: none;
        }

        .fuku-part-box {
            position: absolute;
            width: 37.5px; height: 37.5px;
            display: flex; align-items: center; justify-content: center;
            pointer-events: none;
        }
        .fuku-part-img { max-width: 95%; max-height: 95%; object-fit: contain; }

        #emotion-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 20;
        }
        
        .grill-container {
            position: relative;
            width: 280px; height: 150px;
            background: #333; border: 8px solid #555; border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 8px 0 #222, 0 15px 25px rgba(0,0,0,0.1);
            z-index: 5;
        }
        .grill-mesh {
            width: 100%; height: 100%;
            background-image: 
                linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            position: absolute; top: 0; left: 0;
        }

        .mochi {
            width: 55px; height: 55px;
            background: #fff; border-radius: 10px;
            box-shadow: inset -3px -3px 8px rgba(0,0,0,0.1), 0 3px 5px rgba(0,0,0,0.2);
            cursor: grab; display: flex; align-items: center; justify-content: center;
            position: absolute; z-index: 100; transition: transform 0.1s;
            touch-action: none;
        }
        .mochi-skin { width: 80%; height: 80%; border-radius: 8px; transition: background 10s linear, transform 2.5s ease-in-out; }

        .tray {
            width: 100%; height: 90px; background: #d4a373; border-radius: 20px 20px 0 0;
            display: flex; justify-content: center; align-items: center; gap: 15px;
            padding: 10px; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); margin-top: 15px;
        }

        .dragging { position: fixed !important; z-index: 2000 !important; pointer-events: none; opacity: 0.9; }

        #message {
            position: fixed; top: 20%; font-size: 1.4rem; font-weight: bold; color: #d85c27;
            text-shadow: 2px 2px 0 white; pointer-events: none; display: none; z-index: 2000;
            text-align: center; width: 100%;
        }

        .score-panel {
            background: rgba(255, 255, 255, 0.9);
            padding: 4px 8px;
            border-radius: 10px;
            border: 2px solid #d4a373;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            min-width: 55px;
        }

        #result-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 3000; display: none; align-items: center; justify-content: center;
        }
        .result-card {
            background: white; padding: 30px; border-radius: 24px; text-align: center;
            max-width: 320px; width: 90%; box-shadow: 0 20px 40px rgba(0,0,0,0.3); border: 5px solid #d85c27;
        }

        .url-input-container {
            width: 95%; max-width: 450px; background: rgba(255, 255, 255, 0.4);
            padding: 6px; border-radius: 12px; display: flex; gap: 6px;
            border: 1px solid rgba(212, 163, 115, 0.5);
        }
        .url-input { flex-grow: 1; padding: 4px 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 11px; outline: none; }
        .url-btn { background: #d85c27; color: white; padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: bold; cursor: pointer; white-space: nowrap; }
    </style>
</head>
<body>

<div class="game-outer">
    <div class="game-container">
        <!-- Result Overlay -->
        <div id="result-overlay">
            <div class="result-card">
                <h2 class="text-xl font-bold text-stone-700 mb-2">ごちそうさまでした！</h2>
                
                <div class="flex flex-col gap-4 mb-6 mt-4">
                    <div class="bg-orange-50 p-3 rounded-xl border border-orange-200">
                        <div class="text-xs text-orange-400 font-bold">平均点</div>
                        <div id="result-avg-score" class="text-4xl font-black text-orange-600">80点</div>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-xl border border-blue-200">
                        <div class="text-xs text-blue-400 font-bold">最高点（ベストショット）</div>
                        <div id="result-best-score" class="text-3xl font-black text-blue-600">95点</div>
                    </div>
                </div>

                <div id="result-comment" class="text-lg text-stone-600 mb-6 font-bold">うまいワン</div>
                <button onclick="closeResult()" class="bg-stone-700 text-white px-8 py-3 rounded-full font-bold hover:bg-stone-800 transition-all">もう一度焼く</button>
            </div>
        </div>

        <div class="game-header">
            <div class="header-top-row">
                <h1 class="text-sm font-bold text-stone-700">シロクマのお餅焼き</h1>
                <div class="score-row">
                    <div class="score-panel">
                        <div class="text-[8px] text-stone-500 font-bold leading-tight">今回の最高</div>
                        <div id="best-score" class="text-sm font-black text-blue-600 leading-none">0</div>
                    </div>
                    <div class="score-panel">
                        <div class="text-[8px] text-stone-500 font-bold leading-tight">たべた数</div>
                        <div id="mochi-count" class="text-sm font-black text-orange-600 leading-none">0</div>
                    </div>
                </div>
            </div>
            <div class="url-input-container">
                <input type="text" id="urlInput" class="url-input" placeholder="福笑いのURLを貼り付け">
                <button id="loadUrlBtn" class="url-btn">顔を更新</button>
            </div>
        </div>

        <div id="message">おいしそうだワン！</div>

        <div class="stage">
            <div class="bear-shadow"></div>
            <div class="fukuwarai-viewer">
                <div class="bear-face-system" id="bearSystem">
                    <img src="https://6zr.github.io/fuku2026/images/face.png" class="face-base" id="faceImg" alt="シロクマ" crossorigin="anonymous">
                    <div id="fuku-parts-container"></div>
                    <svg id="emotion-layer" viewBox="0 0 240 264">
                        <g id="wrinkle" style="display:none;" stroke="#4a5568" stroke-width="2.5" fill="none" stroke-linecap="round">
                            <line x1="-4" y1="-8" x2="-4" y2="8" />
                            <line x1="4" y1="-8" x2="4" y2="8" />
                        </g>
                        <g id="joy-stars" style="display:none;" fill="#ffcc00">
                            <path d="M50 60 l3-3 3 3-3 3z M190 60 l3-3 3 3-3 3z" />
                        </g>
                        <g id="surprise" style="display:none;">
                            <text x="200" y="60" font-family="Arial" font-weight="bold" font-size="40" fill="#ff4500" transform="rotate(15, 200, 60)">!</text>
                        </g>
                        <g id="tears" style="display:none;" fill="#4169e1" opacity="0.8">
                            <rect id="tearL" x="0" y="0" width="6" height="12" rx="3" />
                            <rect id="tearR" x="0" y="0" width="6" height="12" rx="3" />
                        </g>
                    </svg>
                </div>
            </div>
            
            <div class="grill-container" id="grill">
                <div class="fire-glow" style="position: absolute; width: 80%; height: 60%; background: radial-gradient(circle, rgba(255,69,0,0.4) 0%, transparent 70%); animation: flicker 1.5s infinite alternate;"></div>
                <div class="grill-mesh"></div>
            </div>
        </div>

        <div class="tray" id="tray"></div>
        <div class="mt-4">
            <button id="finishBtn" class="bg-white border-2 border-stone-300 text-stone-500 px-6 py-2 rounded-full font-bold hover:bg-stone-50 transition-all opacity-0 pointer-events-none">おなかいっぱいだワン！</button>
        </div>
    </div>

    <footer class="text-slate-400 text-sm flex flex-col items-center py-6">
        <div class="mb-4">
            <a href="../" class="flex items-center hover:text-slate-600 transition-colors bg-white px-4 py-2 rounded-full shadow-sm border border-slate-100">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                </svg>
                トップへもどる
            </a>
        </div>
        <p>© 2026 6zr / fuku2026</p>
    </footer>
</div>

<script>
    // --- 状態管理用変数 ---
    const grill = document.getElementById('grill');
    const tray = document.getElementById('tray');
    const bearSystem = document.getElementById('bearSystem');
    const fukuContainer = document.getElementById('fuku-parts-container');
    const faceImg = document.getElementById('faceImg');
    const message = document.getElementById('message');
    const urlInput = document.getElementById('urlInput');
    const loadUrlBtn = document.getElementById('loadUrlBtn');
    const finishBtn = document.getElementById('finishBtn');
    const mochiCountEl = document.getElementById('mochi-count');
    const bestScoreEl = document.getElementById('best-score');
    
    const resultOverlay = document.getElementById('result-overlay');
    const resultAvgScoreEl = document.getElementById('result-avg-score');
    const resultBestScoreEl = document.getElementById('result-best-score');
    const resultCommentEl = document.getElementById('result-comment');

    const DEFAULT_FACE_DATA = "W3siaWQiOiJleWVMIiwieCI6MTU4LCJ5IjoyMzMsInIiOjAsInMiOjEuMn0seyJpZCI6ImV5ZVIiLCJ4IjozMjcsInkiOjI2OCwiciI6MCwicyI6MS4yfSx7ImlkIjoibm9zZSIsIngiOjIyNCwieSI6MzUwLCJyIjowLCJzIjoxLjN9XQ==";

    const effects = {
        wrinkle: document.getElementById('wrinkle'),
        joyStars: document.getElementById('joy-stars'),
        surprise: document.getElementById('surprise'),
        tears: document.getElementById('tears')
    };

    let eyePositions = { L: {x:80, y:100}, R: {x:160, y:100} };
    let grillMochiCount = 0;
    let totalEaten = 0;
    let currentSessionScores = []; // 今回の食事リスト（平均計算用）
    let currentMaxScore = 0;       // 今回のセッション中の単発最高スコア
    let mochiStates = new Map();
    let activeMochi = null;
    let offsetX = 0, offsetY = 0;

    // --- 福笑いデータ復元用 ---
    function extractFaceData(input) {
        if (!input) return null;
        try { const url = new URL(input); const f = url.searchParams.get('f'); if (f) return f; } catch (e) {}
        const match = input.match(/[?&]f=([^&?#]+)/);
        if (match && match[1]) return decodeURIComponent(match[1]);
        if (input.length > 20 && /^[A-Za-z0-9+/=]+$/.test(input)) return input;
        return null;
    }

    function getFileName(id) {
        const map = { eyeL: 'eye_l.png', eyeR: 'eye_r.png', nose: 'nose.png', handL: 'hand_l.png', handR: 'hand_r.png', antena: 'antena.png', mikan: 'mikan.png', maguro: 'maguro.png', capSanta: 'cap_santa.png' };
        return map[id] || '';
    }

    function loadFukuwarai(sourceInput) {
        let encodedData = extractFaceData(sourceInput);
        if (!encodedData && !sourceInput) {
            encodedData = extractFaceData(window.location.href) || DEFAULT_FACE_DATA;
        }
        if (encodedData) {
            try {
                const state = JSON.parse(atob(encodedData));
                fukuContainer.innerHTML = '';
                const scaleFactor = 240 / 640;
                state.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'fuku-part-box';
                    div.style.left = (p.x * scaleFactor) + 'px';
                    div.style.top = (p.y * scaleFactor) + 'px';
                    const cpX = (p.x + 50) * scaleFactor;
                    const cpY = (p.y + 50) * scaleFactor;
                    if (p.id === 'eyeL') eyePositions.L = {x: cpX, y: cpY};
                    if (p.id === 'eyeR') eyePositions.R = {x: cpX, y: cpY};
                    div.style.transform = `rotate(${p.r}deg) scale(${p.s})`;
                    const img = document.createElement('img');
                    img.className = 'fuku-part-img';
                    img.src = `https://6zr.github.io/fuku2026/images/${getFileName(p.id)}`;
                    img.crossOrigin = "anonymous";
                    div.appendChild(img);
                    fukuContainer.appendChild(div);
                });
            } catch(e) { console.error(e); }
        }
    }

    // --- ゲームロジック ---
    function createMochi() {
        const m = document.createElement('div');
        m.className = 'mochi';
        const skin = document.createElement('div');
        skin.className = 'mochi-skin';
        m.appendChild(skin);
        return m;
    }

    function refillTray() {
        while (tray.children.length < 3) tray.appendChild(createMochi());
    }

    function onStart(e) {
        const target = e.target.closest('.mochi');
        if (!target || target.classList.contains('on-grill')) return;
        if (e.cancelable) e.preventDefault();
        const touch = e.type.includes('touch') ? e.touches[0] : e;
        activeMochi = target;
        const rect = activeMochi.getBoundingClientRect();
        offsetX = touch.clientX - rect.left;
        offsetY = touch.clientY - rect.top;
        activeMochi.classList.add('dragging');
        document.body.appendChild(activeMochi);
        moveAt(touch.clientX, touch.clientY);
    }

    function moveAt(x, y) {
        if (!activeMochi) return;
        activeMochi.style.left = (x - offsetX) + 'px';
        activeMochi.style.top = (y - offsetY) + 'px';
        const grillRect = grill.getBoundingClientRect();
        if (x > grillRect.left - 20 && x < grillRect.right + 20 && y > grillRect.top - 20 && y < grillRect.bottom + 20) {
            updateEmotion('hot');
        }
    }

    function onMove(e) {
        if (!activeMochi) return;
        const touch = e.type.includes('touch') ? e.touches[0] : e;
        moveAt(touch.clientX, touch.clientY);
    }

    function onEnd() {
        if (!activeMochi) return;
        const rect = activeMochi.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        const grillRect = grill.getBoundingClientRect();

        if (centerX > grillRect.left && centerX < grillRect.right && centerY > grillRect.top && centerY < grillRect.bottom) {
            placeMochiOnGrill(activeMochi, centerX - grillRect.left, centerY - grillRect.top);
        } else {
            activeMochi.remove();
            refillTray();
            updateEmotion('default');
        }
        activeMochi?.classList.remove('dragging');
        activeMochi = null;
    }

    function placeMochiOnGrill(mochi, x, y) {
        mochi.classList.add('on-grill');
        mochi.style.position = 'absolute';
        mochi.style.left = (x - 27.5) + 'px';
        mochi.style.top = (y - 27.5) + 'px';
        grill.appendChild(mochi);
        grillMochiCount++;
        startToasting(mochi);
        refillTray();
        updateEmotion('default');
    }

    function startToasting(mochi) {
        const skin = mochi.querySelector('.mochi-skin');
        let heat = 0;
        const interval = setInterval(() => {
            heat += 1;
            mochiStates.set(mochi, heat);
            if (heat < 50) {
                skin.style.background = `rgb(255, ${255 - heat}, ${255 - heat * 2})`;
                updateEmotion('wakuwaku');
            } else if (heat < 100) {
                const swell = (heat - 50) / 25;
                mochi.style.transform = `scale(${1 + swell * 0.15})`;
                skin.style.transform = `scale(${1 + swell * 0.4}) translateY(-${swell * 8}px)`;
                skin.style.background = `rgb(${255 - (heat-50)}, ${205 - (heat-50)*2}, 150)`;
                updateEmotion('hopping');
            } else if (heat === 100) {
                updateEmotion('ready');
                showEffect("食べごろだワン！");
            } else if (heat > 160) {
                updateEmotion('bad');
                skin.style.background = "#331a00";
            }
            if (heat > 250) {
                updateEmotion('fail');
                clearInterval(interval);
            }
        }, 100);

        mochi.onclick = () => {
            grillMochiCount--;
            mochiStates.delete(mochi);
            let score = 0;
            if (heat < 80) { score = Math.floor((heat / 80) * 50); showEffect(score + "点：生焼けワン"); updateEmotion('raw'); }
            else if (heat >= 80 && heat <= 120) { score = 100 - Math.abs(100 - heat); showEffect(score + "点：うまいワン！"); updateEmotion('happy'); }
            else if (heat > 120 && heat <= 160) { score = 80 - (heat - 120); showEffect(score + "点：もうちょっとだねワン"); updateEmotion('bad'); }
            else { score = -20; showEffect("にがいよ〜ワン（涙）"); updateEmotion('fail'); }
            
            // スコアを記録
            currentSessionScores.push(score);
            
            // セッション内最高記録を更新
            if (score > currentMaxScore) {
                currentMaxScore = score;
                bestScoreEl.textContent = currentMaxScore;
            }

            totalEaten++;
            mochiCountEl.textContent = totalEaten;
            if (totalEaten >= 1) {
                finishBtn.style.opacity = "1";
                finishBtn.style.pointerEvents = "auto";
            }
            mochi.style.opacity = "0";
            setTimeout(() => { mochi.remove(); if (grillMochiCount === 0) setTimeout(() => { if (grillMochiCount === 0) updateEmotion('default'); }, 1500); }, 300);
            clearInterval(interval);
        };
    }

    function updateEmotion(type) {
        bearSystem.classList.remove('anim-wakuwaku', 'anim-hopping');
        Object.values(effects).forEach(el => el.style.display = 'none');
        bearSystem.style.transform = "scale(1)";
        const midX = (eyePositions.L.x + eyePositions.R.x) / 2;
        const midY = (eyePositions.L.y + eyePositions.R.y) / 2;

        if (type === 'wakuwaku' || type === 'hopping') {
            let maxHeat = 0;
            mochiStates.forEach(val => { if(val > maxHeat) maxHeat = val; });
            if (maxHeat > 0 && maxHeat < 50) { bearSystem.classList.add('anim-wakuwaku'); return; }
            else if (maxHeat >= 50 && maxHeat < 100) { bearSystem.classList.add('anim-hopping'); return; }
        }
        switch(type) {
            case 'hot': effects.surprise.style.display = 'block'; bearSystem.style.transform = "translateY(-4px) rotate(1deg)"; break;
            case 'ready': effects.joyStars.style.display = 'block'; bearSystem.classList.add('anim-hopping'); break;
            case 'happy': effects.joyStars.style.display = 'block'; bearSystem.style.transform = "scale(1.1) rotate(3deg)"; break;
            case 'raw': effects.wrinkle.setAttribute('transform', `translate(${midX}, ${midY - 18})`); effects.wrinkle.style.display = 'block'; bearSystem.style.transform = "scale(0.95) translateY(2px)"; break;
            case 'bad': effects.wrinkle.setAttribute('transform', `translate(${midX}, ${midY - 18})`); effects.wrinkle.style.display = 'block'; break;
            case 'fail': 
                effects.wrinkle.setAttribute('transform', `translate(${midX}, ${midY - 18})`); effects.wrinkle.style.display = 'block';
                document.getElementById('tearL').setAttribute('x', eyePositions.L.x - 3); document.getElementById('tearL').setAttribute('y', eyePositions.L.y + 12);
                document.getElementById('tearR').setAttribute('x', eyePositions.R.x - 3); document.getElementById('tearR').setAttribute('y', eyePositions.R.y + 12);
                effects.tears.style.display = 'block'; bearSystem.style.transform = "translateY(3px)"; break;
            case 'default': bearSystem.style.transform = "scale(1)"; break;
        }
    }

    function showEffect(txt) {
        message.textContent = txt; message.style.display = 'block';
        setTimeout(() => { if(message.textContent === txt) message.style.display = 'none'; }, 1800);
    }

    // --- 判定完了ボタンの処理 ---
    finishBtn.onclick = () => {
        if (currentSessionScores.length === 0) return;
        
        // 平均点を計算
        const avg = Math.round(currentSessionScores.reduce((a, b) => a + b, 0) / currentSessionScores.length);
        
        // リザルト画面に数値をセット
        resultAvgScoreEl.textContent = avg + "点";
        resultBestScoreEl.textContent = currentMaxScore + "点";

        let comment = "";
        if (avg >= 100) comment = "かんぺきワン！";
        else if (avg >= 80) comment = "うまいワン";
        else if (avg >= 50) comment = "もうちょっとだねワン";
        else if (avg >= 0) comment = "生焼けワン";
        else comment = "にがいよ〜ワン（涙）";

        resultCommentEl.textContent = comment;
        resultOverlay.style.display = 'flex';
    };

    window.closeResult = () => {
        resultOverlay.style.display = 'none';
        
        // 「もう一度焼く」で全ての記録を完全にリセット
        currentSessionScores = [];
        currentMaxScore = 0;
        totalEaten = 0;
        
        // 表示のリセット
        bestScoreEl.textContent = "0";
        mochiCountEl.textContent = "0";
        finishBtn.style.opacity = "0";
        finishBtn.style.pointerEvents = "none";
        
        updateEmotion('default');
    };

    loadUrlBtn.addEventListener('click', () => {
        loadFukuwarai(urlInput.value);
        showEffect("顔を読み込みました");
    });

    // --- イベントリスナー ---
    window.addEventListener('mousedown', onStart);
    window.addEventListener('touchstart', onStart, { passive: false });
    window.addEventListener('mousemove', onMove);
    window.addEventListener('touchmove', onMove, { passive: false });
    window.addEventListener('mouseup', onEnd);
    window.addEventListener('touchend', onEnd);

    if (faceImg.complete) init();
    else faceImg.onload = init;

    function init() {
        refillTray();
        loadFukuwarai();
    }
</script>

</body>
</html>
